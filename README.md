# metalisx

===

Project has not been updated in a while. 
You should not use AngularJS anymore, use Angular.

===

This is a working experiment using an AngularJS front end to show messages and a java backend to log messages.

The projects are created to:
 - create reusable projects for JPA and REST
 - create a reusable structure for REST applications
   A CRUD and a request and logging monitor application 
   are used as use case.
 - test frameworks, java and javascript/css frameworks

MetalIsX contains the following sections:
 - MetalIsX common
 - MetalIsX CRUD
 - MetalIsX Monitor

The section structure is created to make it
possible to build a group of projects.

The following Java frameworks are used in the java 
backend:
 - JPA (Hibernate)
 - REST (JBoss RESTEasy with Gson)
 - JBoss Hibernate
 - Apache HttpComponents
 - Tika
 - Tagsoup
 - Liquibase
 - JUnit
 - JBoss Arquillian

The following Javascript and CSS frameworks are used
in the front end:
 - Twitter Bootstrap
 - jQuery 
 - AngularJS
 - DataTables
 - Dynatree
 - Flot
 - google-code-prettify

## 0 Setup

Quick setup instructions for:
 - Maven and building the projects with Maven
 - Eclipse and loading the projects in Eclipse
 - JBoss server in Eclipse.

### 0.1 Maven

Install Maven (currently Maven 3.0.5).

To build all projects run the following command from this
directory:
```
 mvn clean install -DskipTests
```
 
If you only want one section to build, run the command 
from it's sub folder in this directory. But to build the 
section CRUD or Monitor, you need to build the common 
section first.

### 0.2 Eclipse

Use with Eclipse:
 - download and install Eclipse (currently Neon M6)
 - open Eclipse
 - import the previous build projects as Maven projects.

If you only want one section then import the pom of
it's sub folder.

#### 0.2.1 Error: Multiple JAX-RS Activators are defined for the project

The JBoss Tools validator for JAX-RS thinks it detected the error: 
```
 Multiple JAX-RS Activators are defined for the project.
```
This is incorrect because the Applications are defined in different 
projects. The solution is to set the validator check to Warning by 
following the next instructions:
 - go to Menu -> Window -> Preferences
 - go to JBoss Tools -> JAX-RS -> JAX-RS Validator
 - Klik on "JAX-RS Activators"
 - go to "Multiple JAX-RS Activators configured"
 - set the listbox value on Warning

### 0.3 WildFly

Setting up WildFly:
 - download WildFly 10.0.0 Final and unzip the file.
 - open Eclipse
 - install the JBoss Tools (currently 4.3.0.Final) from the Eclipse Market Place
 - create a new Serer, with server type WildFly 10.0 (Experimental) and
   point it to the installation directory of the unzipped WildFly.

When running the MetalIsX web applications you need to configure the 
Monitor datasource and Monitor log file. For instructions see: 
4 WildFly

## 1 MetalIsX common

Common projects for domain, gson, rest and web resources.

## 2 MetalIsX CRUD

Simple but effective CRUD web application project using the 
common rest module.

## 3 MetalIsX Monitor

Project for:
 - displaying profiling log information
 - displaying log information
 - displaying request/response information

Profiling log information is stored in a database and 
shown in the web application. Profiling information is 
read from log statements in a log file and then added 
to the database. The log statement are written to the 
log file by other applications. There are two artifacts 
you can use to generate the log statements, read:
 - Profiler slf4j CDI Interceptor
 - Profiler slf4j servlet filter
A hierarchy of the log statements can be displayed if
the depth is used in the log statements.

Beside profiling information the application can read
normal log statements as long as the log statements 
contain the required monitor information.
 - Monitor Context

It can also read log statements generated by artificats
which are not under your control, for instance Hibernate. 
Read:
 - Monitor Context slf4j MDC

Request/response information is stored in a database
and shown in the web application. To configure your
application to log the request and response information
read:
 - Request servlet filter
Log information, if available, is also bind to the
request.

### 3.1 Browsers

The web applications are supported in the browsers Firefox, 
Chrome and Internet Explorer 10+, Edge.

### 3.2 Application Server

The monitor web application is developed for the WildFly 10.0.0.Final
application server.

The monitor web application uses:
 - Servlet 3.1
 - EJB
 - CDI

The monitor web application should run on other application
servers but in the pom the artifacts which are provided by
WildFly 10.0.0.Final as modules are marked as provided. They
might not be available on other application servers.

### 3.3 Datasource

To use the web application monitor-war and/or servlet filter monitor-request-servlet-filter a 
datasource has to be configured in the application server. The name of the data 
source is: 
```
jdbc/monitorDS.
```

### 3.4 Generate log statements

#### 3.4.1 Monitor context

To generate log statements for the monitor application to read, you
add the following artifact to your project:
 - monitor-context

#### 3.4.2 Monitor context using slf4j MDC

If you need the application to read the log statements generated
by an artifact which you do not control, you add the following 
artifact to your project:
 - monitor-context-slf4j-mdc
This requires changing the log format in the logging 
configuration to utilize MDC so it logs the required 
monitor information.

When used with Hibernate logging, the Hibernate log statements
are bind to the request responsible for the logging. This will 
make it easy to see what a request of a specific organization 
and user executes.

#### 3.4.3 Disable log listener

It is possible to prevent the log listener from reading log
statements per thread. This is done by adding marker log statements.
Make sure that the marker log statements are placed in the log file
the monitor is listening to.

Disable the processing by calling the {@link #getDisableMarker(String)} with
the thread name and then placing the return value in the log file.

Now all log statements for this thread are skipped by the log listeners.

Then enable the processing by calling the {@link #getEnableMarker(String)}
with the thread name and then placing the return value in the log file.

Now all log statements for this thread are processed again.

The best way to use the disable and enable markers is by placing them in the
log file by the same method, this will prevent every log statements between
those commands to be processed by the log listener.

### 3.5 Profiler slf4j CDI Interceptor

The profiler interceptor logs duration of method calls, which
can be read by the web application.

To use it in an CDI enabled project add the 
monitor-profiler-slf4j-cdi-interceprtor artifact to your project.

This artifact provides the ProfilerInterceptor class and you can use it:
 - with CDI by adding the interceptor class to the beans.xml 
   and adding the annotation @Profile on your class

Alternatively you can use the ProfilerInterceptor class as an 
EJB interceptor:
 - with adding the Interceptors annotation containing the interceptor
   class to your class
 - with adding the interceptor class as a default interceptor in the ejb-jar.xml

#### 3.5.1 CDI interceptor

Add the ProfilerInterceptor in the beans.xml:
```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://java.sun.com/xml/ns/javaee" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/beans_1_0.xsd">
	<interceptors>
		<class>org.metalisx.monitor.domain.interceptor.ProfilerInterceptor</class>
	</interceptors>
</beans>
```

Annotated your class with the Profiler annotation.
Example class:
```
package org.metalisx.my.package

import org.metalisx.monitor.domain.interceptor.Profile;

@Profile
public abstract class AbstractService {
	..
}
```

#### 3.5.2 Interceptors annotation

Add the ProfilerInterceptor to the EJB with the Interceptors annotation:
```
@Interceptors({ProfilerInterceptor.class})
```

#### 3.5.3 Default interceptor

Add the ProfilerInterceptor in the META-INF/ejb-jar.xml:
```
<assembly-descriptor>
    <interceptor-binding>
        <ejb-name>*</ejb-name>
        <interceptor-class>org.metalisx.monitor.domain.interceptor.ProfilerInterceptor</interceptor-class>
    </interceptor-binding>
</assembly-descriptor>
```

### 3.6 Profiler slf4j servlet filter

The profiler filter logs duration of the servlet call, which
can be read by the web application.

To use it in a Servlet 3.0 enabled application server add the
monitor-profiler-slf4j-servlet-filter artifact to your project.

The web fragment included in the artifact will be used by
a Servlet 3.0 application server to start the servlet filter.

### 3.7 Request servlet filter

The request servlet filter stores the information of the request and
response into the datasource as mentioned in the datasource
section. When the profiler interceptor and/or profiler servlet filter
are also used the log statements are connected to the request.

To use it in a Servlet 3.0 enabled application server add the
monitor-request-servlet-filter artifact to your project.

The web fragment included in the artifact will be used by
a Servlet 3.0 application server to start the servlet filter.

### 3.8 Profiler filter and request filter

The web fragments of both artifacts will be used by a 
Servlet 3.0 application server to start both servlet filters
but the order in which they start is not determined.

To make sure the request filter is started before the
profiler filter you need to add the following to your 
web.xml:
```
	<absolute-ordering>
		<others/>
		<name>monitorRequestServletFilter</name>
		<name>monitorProfilerServletFilter</name>
	</absolute-ordering>
```

The 'others' is specified before the request filter
because a filter can be used to set the username
and organizatoin in the MonitorContext to personalize
the request.

## 4 WildFly

### 4.1 Datasource

Instructions to configure WildFly 10.0.0.Final standalone 
with the required jdbc/monitorDS datasource:
 - open the file <jboss home>/standalone/configuration/standalone.xml
 - find the subsystem with the datasources
 - add in the datasources section the following datasource to create a h2 database:
                ```
                <datasource jndi-name="java:/jdbc/monitorDS" pool-name="monitorDS" enabled="true" use-java-context="true">
                    <connection-url>jdbc:h2:file:${jboss.server.data.dir}/h2database/monitor;DB_CLOSE_DELAY=-1</connection-url>
                    <driver>h2</driver>
                    <security>
                        <user-name>sa</user-name>
                        <password>sa</password>
                    </security>
                </datasource>
                ```
 - you can change the datasource setting to your liking, but the 
   jndi-name should remain the same

### 4.2 Logger

Instructions to configure WildFly 10.0.0.Final standalone with
a seperated log file for the monitor application:
 - open the file <jboss home>/standalone/configuration/standalone.xml
 - find the subsystem with the logging
 - add in the subsystem the following file handler:
            ```
            <periodic-rotating-file-handler name="MONITOR" autoflush="true">
                <formatter>
                    <pattern-formatter pattern="%d %-5p [%c] (%t) %s%E%n"/>
                    <!-- when using the monitor-context-slf4j-mdc filter enable the following pattern-formatter
                    <pattern-formatter pattern="%d %-5p [%c] (%t) [SessionId: %X{sessionid}, RequestId: %X{requestid}, ParentRequestId: %X{parentrequestid}, Organisatie: %X{organization}, Gebruikersnaam: %X{username}] (Depth: %X{depth}) %s%E%n"/>
                    -->
                </formatter>
                <file relative-to="jboss.server.log.dir" path="monitor.log"/>
                <suffix value=".yyyy-MM-dd"/>
                <append value="false"/>
            </periodic-rotating-file-handler>
            ```

 - add in the subsystem the following logger for logging en processing
   monitor logging:
            ```
            <logger category="org.metalisx.monitor" use-parent-handlers="false">
                <level name="INFO"/>
                <handlers>
                    <handler name="MONITOR"/>
                </handlers>
            </logger>
            ```
 - add in the subsystem the following logger for logging en processing 
   hibernate logging:
            ```
            <logger category="org.hibernate.SQL" use-parent-handlers="false">
                <level name="DEBUG"/>
                <handlers>
                    <handler name="MONITOR"/>
                </handlers>
            </logger>
            <logger category="org.hibernate.type" use-parent-handlers="false">
                <level name="DEBUG"/>
                <handlers>
                    <handler name="MONITOR"/>
                </handlers>
            </logger>
            ```

## 5 Eclipse and Checkstyle

Install and configure Checkstyle in Ecipse:
 - go to the Eclipse market place, search for Checkstyle Plug-in and install it.
 - go to Window -> Preferences -> Checkstyle
 - click on 'New' to open the 'Check configuration Properties' window
 - enter the follwing values:
     type = External Configuration File
     name = Monitor
 - click on 'Browse' and select the checkstyle.xml file in this directory
 - click on 'Additional properties' to open the 'Checkstyle configuration file properties' window
 - click on 'Add' to open the 'Checkstyle configuration property editor'
 - enter the following values:
     name = checkstyle.suppressions.file
     value = ${project_loc}/checkstyle-suppressions.xml
 - click 'Ok'
 - click 'Ok', 'Monitor' should be visible in the 'Global Check Configuration' list
 - click on 'Monitor' and then click on 'Set as default'
 - click 'Ok'
 - restart Eclipse
 - now you can validate the project or source by:
    - right click the project or source
    - click on Checkstyle
    - click on Check code with Checkstyle
 
## 6 Code quality

Checkstyle and PMD are configured to report on the code quality.
To run Checkstyle and PMD run:
```
 mvn -P quality verify
```

## 7 Site

To create the site on the modules run:
```
 mvn -P quality site
```
This will also run Checkstyle and PMD.

To deploy the site run:
```
 mvn -P quality site:deploy
```
This will copy all site information from the target direcotories to
the directory: /workspace-monitor/site

## 8 Unit testing

Arquillian is used for unit testing. 

### 8.1 Web application

Arquillian uses selenium and webdrivers for testing web applications.

The applications monitor-war is configured for running against browsers
and a headless browser.

After executing the instruction in the sub paragraphes you can run test
at the browser in that sub paragraphes or you can run it against all 
these browsers at once by running:
```
 mvn clean install -Pphantomjs,firefox,chrome,internet-explorer
```

#### 8.1.1 Headless

For testing the web application the headless browser PhantomJS is used. 
This requires no extra installations.

Run: 
```
 mvn clean install -Pphantomjs
```

#### 8.1.2 Browsers

For testing against a browser you need to install the browser and 
possible a webdriver.
The links to the webdrivers can be found on the Selenium download 
page: http://seleniumhq.org/download/

##### 8.1.2.1 FireFox

Actions:
 - Install FireFox.
 - It might be possible that you need to install the Selenium IDE in FireFox.

Run: 
```
 mvn clean install -Pfirefox
```

##### 8.1.2.2 Chrome

Actions:
 - Install Chrome.
 - Install the chrome webdriver.

The Chrome webdriver can be found here: https://sites.google.com/a/chromium.org/chromedriver/
Create the selenium-webdriver directory in the root of the drive where the 
project is located. Place the webdriver in this directory.

Run: 
```
 mvn clean install -Pchrome
```

##### 8.1.2.3 Internet Explorer

Actions:
 - Install Internet Explorer.
 - Install the Internet Explorer webdriver.

The home page for the Internet Explorer webdriver is:
https://code.google.com/p/selenium/wiki/InternetExplorerDriver

The Internet Explorer webdriver can be found here: 
http://selenium-release.storage.googleapis.com/index.html

To make the webdriver work for your version of Internet Explorer read:
https://code.google.com/p/selenium/wiki/InternetExplorerDriver#Required_Configuration

Create the selenium-webdriver directory in the root of the drive where the 
project is located. Place the webdriver in this directory.

run:
```
 mvn clean install -Pinternet-explorer
```
