MetalIsX

The projects are created to:
 - create reusable projects for JPA and REST
 - create a reusable structure for REST applications
   A CRUD and a request and logging monitor application 
   are used as use case.
 - test frameworks, java and javascript/css frameworks

MetalIsX contains the following sections:
 - MetalIsX common
 - MetalIsX CRUD
 - MetalIsX Monitor

The section structure is created to make it
possible to build a group of projects.

The following Java frameworks are used in the java 
backend:
     - JPA (Hibernate)
     - REST (JBoss RESTEasy with Gson)
     - JBoss Hibernate
     - Apache HttpComponents
     - Tika
     - Tagsoup
     - Liquibase
     - JUnit
     - JBoss Arquillian

The following Javascript and CSS frameworks are used
in the front end:
     - Twitter Bootstrap
     - jQuery 
     - AngularJS
     - DataTables
     - Dynatree
     - Flot
     - google-code-prettify

0 Setup

Quick setup instructions for:
 - Maven and building the projects with Maven
 - Eclipse and loading the projects in Eclipse
 - JBoss server in Eclipse.

0.1 Maven

Install Maven (currently Maven 3.0.5).

To build all projects run the following command from this
directory:
 mvn clean install -DskipTests
 
If you only want one section to build, run the command 
from it's sub folder in this directory. But to build the 
section CRUD or Monitor, you need to build the common 
section first.

0.2 Eclipse

Download and install Eclipse (currently Luna R)
Luna contains m2e.

Open Eclipse

Import the projects as Maven projects by selecting the 
sub folder of a section. It is not possible to load all 
projects at once from the pom in this directory.

0.3 WildFly 8.1.0

Download WildFly 8.1.0 Final and unzip the file.

Open Eclipse

Install the JBoss Tools (Luna) from the Eclipse Market Place

Create a new Serer, with server type WildFly 8.x and
point it to the installation directory of the unzipped WildFly.

When running the MetalIsX web applications you need to 
configure the datasource with jndi-name java:jdbc/monitorDS
Follow the configuration of the datasource in the 
section MetalIsX Monitor.

1. MetalIsX common

Common projects for domain, gson, rest and web resources.

2. MetalIsX CRUD

Project for a CRUD rest and CRUD web application.

3. MetalIsX Monitor

Project for:
 - displaying profiling log information
 - displaying log information
 - displaying request/response information

Profiling log information is stored in a database and 
shown in the web application. Profiling information is 
read from log statements in a log file and then added 
to the database. The log statement are written to the 
log file by other applications. There are two artifacts 
you can use to generate the log statements, read:
 - Profiler slf4j CDI Interceptor
 - Profiler slf4j servlet filter
A hierarchy of the log statements can be displayed if
the depth is used in the log statements.

Beside profiling information the application can read
normal log statements as long as the log statements 
contain the required monitor information.
 - Monitor Context

It can also read log statements generated by artificats
which are not under your control, for instance Hibernate. 
Read:
 - Monitor Context slf4j MDC

Request/response information is stored in a database
and shown in the web application. To configure your
application to log the request and response information
read:
 - Request servlet filter
Log information, if available, is also bind to the
request.


3.1 Browsers

The web applications are supported in the browsers Firefox, 
Chrome and Internet Explorer 8+.

3.2 Application Server

The monitor web application is developed for the WildFly 8.1.0.Final
application server.

The monitor web application uses:
 - Servlet 3.0
 - EJB
 - CDI

The monitor web application should run on other application
servers but in the pom the artifacts which are provided by
WildFly 8.1.0.Final as modules are marked as provided. They
might not be available on other application servers.

3.3 Datasource

To use the web application monitor-war and/or servlet filter monitor-request-servlet-filter a 
datasource has to be configured in the application server. The name of the data 
source is: jdbc/monitorDataSource.

3.4 Generate log statements

3.4.1 Monitor context

To generate log statements for the monitor application to read, you
add the following artifact to your project:
 - monitor-context

3.4.2 Monitor context using slf4j MDC

If you need the application to read the log statements generated
by an artifact which you do not control, you add the following 
artifact to your project:
 - monitor-context-slf4j-mdc
This requires changing the log format in the logging 
configuration to utilize MDC so it logs the required 
monitor information.

When used with Hibernate logging, the Hibernate log statements
are bind to the request responsible for the logging. This will 
make it easy to see what a request of a specific organization 
and user executes.

3.4.3 Disable log listener

It is possible to prevent the log listener from reading log
statements per thread. This is done by adding marker log statements.
Make sure that the marker log statements are placed in the log file
the monitor is listening to.

Disable the processing by calling the {@link #getDisableMarker(String)} with
the thread name and then placing the return value in the log file.

Now all log statements for this thread are skipped by the log listeners.

Then enable the processing by calling the {@link #getEnableMarker(String)}
with the thread name and then placing the return value in the log file.

Now all log statements for this thread are processed again.

The best way to use the disable and enable markers is by placing them in the
log file by the same method, this will prevent every log statements between
those commands to be processed by the log listener.

3.5. Profiler slf4j CDI Interceptor

The profiler interceptor logs duration of method calls, which
can be read by the web application.

To use it in an CDI enabled project add the 
monitor-profiler-slf4j-cdi-interceprtor artifact to your project.

This artifact provides the ProfilerInterceptor class and you can use it:
 - with CDI by adding the interceptor class to the beans.xml 
   and adding the annotation @Profile on your class

Alternatively you can use the ProfilerInterceptor class as an 
EJB interceptor:
 - with adding the Interceptors annotation containing the interceptor
   class to your class
 - with adding the interceptor class as a default interceptor in the ejb-jar.xml

3.5.1 CDI interceptor

Add the ProfilerInterceptor in the beans.xml:
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://java.sun.com/xml/ns/javaee" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/beans_1_0.xsd">
	<interceptors>
		<class>org.metalisx.monitor.domain.interceptor.ProfilerInterceptor</class>
	</interceptors>
</beans>

Annotated your class with the Profiler annotation.
Example class:
package org.metalisx.my.package

import org.metalisx.monitor.domain.interceptor.Profile;

@Profile
public abstract class AbstractService {
	..
}

3.5.2 Interceptors annotation

Add the ProfilerInterceptor to the EJB with the Interceptors annotation:
@Interceptors({ProfilerInterceptor.class})

3.5.3 Default interceptor

Add the ProfilerInterceptor in the META-INF/ejb-jar.xml:
<assembly-descriptor>
    <interceptor-binding>
        <ejb-name>*</ejb-name>
        <interceptor-class>org.metalisx.monitor.domain.interceptor.ProfilerInterceptor</interceptor-class>
    </interceptor-binding>
</assembly-descriptor>

3.6 Profiler slf4j servlet filter

The profiler filter logs duration of the servlet call, which
can be read by the web application.

To use it in a Servlet 3.0 enabled application server add the
monitor-profiler-slf4j-servlet-filter artifact to your project.

The web fragment included in the artifact will be used by
a Servlet 3.0 application server to start the servlet filter.

3.7 Request servlet filter

The request servlet filter stores the information of the request and
response into the datasource as mentioned in the datasource
section. When the profiler interceptor and/or profiler servlet filter
are also used the log statements are connected to the request.

To use it in a Servlet 3.0 enabled application server add the
monitor-request-servlet-filter artifact to your project.

The web fragment included in the artifact will be used by
a Servlet 3.0 application server to start the servlet filter.

3.8 Profiler filter and request filter

The web fragments of both artifacts will be used by a 
Servlet 3.0 application server to start both servlet filters
but the order in which they start is not determined.

To make sure the request filter is started before the
profiler filter you need to add the following to your 
web.xml.
	<absolute-ordering>
		<others/>
		<name>monitorRequestServletFilter</name>
		<name>monitorProfilerServletFilter</name>
	</absolute-ordering>

The 'others' is specified before the request filter
because a filter can be used to set the username
and organizatoin in the MonitorContext to personalize
the request.

4 WildFly 8.1.0.Final

4.1 Datasource

Instructions to configure WildFly 8.1.0.Final standalone 
with the required jdbc/monitorDS datasource:
 - open the file <jboss home>/standalone/configuration/standalone.xml
 - find the subsystem with the datasources
 - add in the datasources section the following datasource to create a h2 database:
                <datasource jndi-name="java:/jdbc/monitorDS" pool-name="monitorDS" enabled="true" use-java-context="true">

                    <connection-url>jdbc:h2:file:${jboss.server.data.dir}/h2database/monitor;DB_CLOSE_DELAY=-1</connection-url>

                    <driver>h2</driver>

                    <security>

                        <user-name>sa</user-name>

                        <password>sa</password>
                    </security>

                </datasource>

 - you can change the datasource setting to your liking, but the 
   jndi-name should remain the same

4.2 Logger

Instructions to configure a seperated log file for the monitor application:
 - open the file <jboss home>/standalone/configuration/standalone.xml
 - find the subsystem with the logging
 - add in the subsystem the following file handler:
            <periodic-rotating-file-handler name="MONITOR" autoflush="true">

                <formatter>

                    <pattern-formatter pattern="%d %-5p [%c] (%t) [SessionId: %X{sessionid}, RequestId: %X{requestid}, ParentRequestId: %X{parentrequestid}, Organisatie: %X{organization}, Gebruikersnaam: %X{username}] (Depth: %X{depth}) %s%E%n"/>

                </formatter>

                <file relative-to="jboss.server.log.dir" path="monitor.log"/>

                <suffix value=".yyyy-MM-dd"/>

                <append value="false"/>

            </periodic-rotating-file-handler>

 - add in the subsystem the following logger for logging en processing
   monitor logging:
            <logger category="org.metalisx.monitor" use-parent-handlers="false">
                <level name="INFO"/>

                <handlers>

                    <handler name="MONITOR"/>

                </handlers>
            </logger>

 - add in the subsystem the following logger for logging en processing 
   hibernate logging:
            <logger category="org.hibernate.SQL" use-parent-handlers="false">

                <level name="DEBUG"/>

                <handlers>

                    <handler name="MONITOR"/>

                </handlers>

            </logger>

            <logger category="org.hibernate.type" use-parent-handlers="false">

                <level name="DEBUG"/>

                <handlers>
                    <handler name="MONITOR"/>

                </handlers>

            </logger>

5 Eclipse and Checkstyle

Install and configure Checkstyle in Ecipse:
 - go to the Eclipse market place, search for Checkstyle and install it.
 - go to Window -> Preferences -> Checkstyle
 - click on 'New' to open the 'Check configuration Properties' window
 - enter the follwing values:
     type = Project Relative Configuration
     name = Monitor
 - click on 'Browse' and select the checkstyle.xml file in this directory
 - click on 'Additional properties' to open the 'Checkstyle configuration file properties' window
 - click on 'Add' to open the 'Checkstyle configuration property editor'
 - enter the following values:
     name = checkstyle.suppressions.file
     value = ${project_loc}/checkstyle-suppressions.xml
 - click 'Ok'
 - click 'Ok'
 - click 'Ok', 'Monitor' should be visible in the 'Global Check Configuration' list
 - click on 'Monitor' and then click on 'Set as default'
 - restart Eclipse
 - now you can validate the project or source by:
    - right click the project or source
    - click on Checkstyle
    - click on Check code with Checkstyle
 
6 Code quality

Checkstyle and PMD are configured to report on the code quality.
To run Checkstyle and PMD run:
 mvn -P quality verify

7 Site

To create the site on the modules run:
 mvn -P quality site
This will also run Checkstyle and PMD.

To deploy the site run:
 mvn -P quality site:deploy
This will copy all site information from the target direcotories to
the directory: /workspace-monitor/site

8 Unit testing

Download the Chrome and Internet Explorer web drivers for running test with Selenium.
The links to the web drivers can be found on the Selenium download page: http://seleniumhq.org/download/
The current web driver links:
 - Chrome web driver can be found here: http://code.google.com/p/chromedriver/
 - Internet Explorer can be found here: http://code.google.com/p/selenium/downloads/list
